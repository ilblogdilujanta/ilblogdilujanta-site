---
const { title = "Il Blog di Lujanta" } = Astro.props;

import TopNav from "../components/TopNav.astro";
import CookieBanner from "../components/CookieBanner.astro";

const year = new Date().getFullYear();

// ✅ GA4 ID
const GA_ID = "G-4QEGKF1RX0";
---

<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- Meta autore -->
    <meta name="author" content="Lujanta" />
    <meta name="copyright" content={`© ${year} il Blog di Lujanta`} />

    <!-- GTranslate -->
    <script is:inline>
      window.gtranslateSettings = {
        default_language: "it",
        native_language_names: true,
        detect_browser_language: true,
        languages: ["it","de","en","fr"],
        wrapper_selector: ".gtranslate_wrapper"
      };
    </script>
    <script src="https://cdn.gtranslate.net/widgets/latest/lc.js" defer></script>

    <!-- ✅ GOOGLE TAG (caricato sempre) -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>

    <!-- ✅ GA4 con Consent Mode: NON traccia finché non accetti -->
    <script is:inline>
      (function () {
        const KEY = "cookie_consent_v1";
        const GA_ID = "G-4QEGKF1RX0";

        window.dataLayer = window.dataLayer || [];
        function gtag(){ window.dataLayer.push(arguments); }
        window.gtag = gtag;

        gtag("js", new Date());

        // Default: niente analytics finché non c'è consenso
        gtag("consent", "default", {
          ad_storage: "denied",
          analytics_storage: "denied",
          functionality_storage: "granted",
          security_storage: "granted",
          wait_for_update: 500
        });

        function enableAnalytics(){
          // evita doppio config
          if (window.__ga_configured) return;
          window.__ga_configured = true;

          gtag("consent", "update", { analytics_storage: "granted" });

          // inizializza GA4 (solo dopo consenso)
          gtag("config", GA_ID, {
            anonymize_ip: true
          });
        }

        function disableAnalytics(){
          gtag("consent", "update", { analytics_storage: "denied" });
        }

        // Se l'utente ha già scelto in passato
        try {
          const consent = localStorage.getItem(KEY);
          if (consent === "accepted") enableAnalytics();
          if (consent === "rejected") disableAnalytics();
        } catch (e) {}

        // Quando il banner emette l'evento
        window.addEventListener("cookie:consent", (ev) => {
          if (ev.detail === "accepted") enableAnalytics();
          if (ev.detail === "rejected") disableAnalytics();
        });
      })();
    </script>

    <slot name="head" />

    <style is:global>
      .site-footer{
        margin-top: 0px;
        padding: 24px 16px;
        text-align: center;
        font-size: 14px;
        opacity: 0.78;
        border-top: 1px solid rgba(44,36,28,0.25);
      }

      .footer-links{
        margin-top: 14px;
        font-size: 14px;
        opacity: 0.85;
        display:flex;
        justify-content:center;
        gap:8px;
        flex-wrap:wrap;
      }

      .footer-links a{
        color: inherit;
        text-decoration:none;
        border-bottom:1px solid rgba(44,36,28,0.25);
      }
      .footer-links a:hover{
        border-bottom-color: rgba(44,36,28,0.6);
      }

      .cookie-manage{
        border: none;
        background: none;
        font-family: inherit;
        font-size: 14px;
        cursor: pointer;
        color: inherit;
        border-bottom:1px solid rgba(44,36,28,0.25);
        padding: 0;
      }
      .cookie-manage:hover{
        border-bottom-color: rgba(44,36,28,0.6);
      }

      .site-footer p{
        margin: 6px 0;
        line-height: 1.5;
      }
    </style>
  </head>

  <body>
    <TopNav />
    <slot />

    <!-- ✅ Banner Cookie -->
    <CookieBanner />

    <footer class="site-footer" aria-label="Note di copyright">
      <p>© 2016 — 2026 Il Blog di Lujanta – Ricerca, Memoria, Tradizione</p>

      <p>
        Tutti i contenuti di questo sito (testi, immagini, ricerche e materiali originali)
        sono protetti da diritto d’autore.
      </p>

      <p>
        È vietata la riproduzione totale o parziale senza autorizzazione.
        La citazione è consentita esclusivamente indicando chiaramente l’autrice e la fonte.
      </p>

      <nav class="footer-links" aria-label="Link legali">
        <a href="/privacy">Privacy Policy</a>
        <span>·</span>
        <a href="/cookie">Cookie Policy</a>
        <span>·</span>
        <button type="button" class="cookie-manage" data-cookie-manage>
          Gestisci cookie
        </button>
      </nav>
    </footer>

    <!-- ✅ Gestisci cookie: riapre banner -->
    <script is:inline>
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-cookie-manage]");
        if (!btn) return;

        try { localStorage.removeItem("cookie_consent_v1"); } catch (e) {}
        window.location.reload();
      });
    </script>
  </body>
</html>
