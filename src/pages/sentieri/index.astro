---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

type Articolo = {
  slug: string;
  data: {
    title: string;
    date: Date;
    sentieri?: string[];
  };
};

const articoli = (await getCollection("articoli")) as Articolo[];

// slug coerente
const slugify = (s: string) =>
  s
    .toLowerCase()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // via accenti
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");

// ✅ normalizzazione "umana" per evitare duplicati tipo "Veneto " vs "Veneto"
const normalizeLabel = (s: string) =>
  s
    .replace(/\s+/g, " ")  // spazi multipli -> 1
    .trim();               // via spazi iniziali/finali

// ===== SENTIERI (unici + ordinati A→Z) =====
const sentieriMap = new Map<string, string>();
// key = chiave normalizzata per dedup, value = label originale “pulita” da mostrare

for (const a of articoli) {
  for (const raw of a.data.sentieri ?? []) {
    const label = normalizeLabel(raw);
    if (!label) continue;

    // chiave di dedup più “forte”: normalizzo e tolgo accenti/segni per confronto
    const key = label
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[’'"]/g, "")        // apostrofi vari
      .replace(/\s+/g, " ")
      .trim();

    // se esiste già non sovrascrivo (tengo la prima forma “umana”)
    if (!sentieriMap.has(key)) sentieriMap.set(key, label);
  }
}

const sentieri = Array.from(sentieriMap.values()).sort((a, b) =>
  a.localeCompare(b, "it", { sensitivity: "base" })
);

// ===== ARCHIVIO PER ANNO → MESE =====
const archivioPerAnnoMese: Record<number, Record<number, Articolo[]>> = {};

for (const a of articoli) {
  const anno = a.data.date.getFullYear();
  const mese = a.data.date.getMonth(); // 0..11

  archivioPerAnnoMese[anno] ??= {};
  archivioPerAnnoMese[anno][mese] ??= [];
  archivioPerAnnoMese[anno][mese].push(a);
}

const anni = Object.keys(archivioPerAnnoMese)
  .map(Number)
  .sort((a, b) => b - a);

// Nomi mesi in italiano (0..11)
const monthName = (m: number) => {
  const d = new Date(2000, m, 1);
  const s = d.toLocaleDateString("it-IT", { month: "long" });
  return s.charAt(0).toUpperCase() + s.slice(1);
};

const countYear = (anno: number) => {
  const months = archivioPerAnnoMese[anno] || {};
  return Object.values(months).reduce((sum, arr) => sum + arr.length, 0);
};

const titoloPagina = "Sentieri di Lettura";
---

<BaseLayout title={titoloPagina}>
  <style is:global>
    :root{
      --ink:#2c241c;
      --green:#0d8460;

      --paper1:#efe1c5;
      --paper2:#e2caa6;
      --paper3:#d8bc93;
    }

    body{
      margin:0;
      min-height:100vh;
      background: var(--green);
      font-family:
        "Baskerville Old Face","Baskerville","Libre Baskerville",
        Georgia,"Times New Roman",serif;
      color:var(--ink);
    }

    main{
      display:flex;
      justify-content:center;
      padding:32px 14px;
    }

    .paper{
      max-width:980px;
      width:100%;
      padding:60px;
      background:
        radial-gradient(120% 90% at 50% 20%, rgba(255,255,255,0.35), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--paper1), var(--paper2) 55%, var(--paper3));
      border-radius:6px;
      box-shadow:0 18px 60px rgba(0,0,0,0.55);
    }

    h1{
      text-align:center;
      font-size:44px;
      font-weight:400;
      margin:0 0 28px;
    }

    h2{
      font-size:26px;
      font-weight:400;
      margin:56px 0 22px;
      text-align:center;
    }

    .intro{
      max-width:640px;
      margin:0 auto 48px;
      font-size:20px;
      line-height:1.6;
      text-align:center;
    }

    /* GRIGLIA SENTIERI */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:18px;
    }

    .sentiero{
      padding:16px 14px;
      font-size:22px;
      border:1px solid rgba(44,36,28,0.25);
      border-radius:4px;

      /* ✅ centratura perfetta */
      display:flex;
      align-items:center;      /* centro verticale */
      justify-content:center;  /* centro orizzontale */
      text-align:center;

      min-height:84px;
      line-height:1.25;

      text-decoration:none;
      color:var(--ink);
      background:rgba(255,255,255,0.25);
    }

    .sentiero:hover{ background:rgba(255,255,255,0.45); }

    /* ARCHIVIO COLLASSABILE: ANNO */
    .anno{
      margin-bottom:18px;
      border-bottom:1px solid rgba(44,36,28,0.25);
      padding-bottom:12px;
    }

    .anno summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      font-size:22px;
      user-select:none;
    }

    .anno summary::-webkit-details-marker{ display:none; }
    .anno summary::before{
      content:"▸";
      margin-right:8px;
      font-size:18px;
      opacity:0.6;
    }
    .anno[open] summary::before{ content:"▾"; }

    .anno-count{ font-size:14px; opacity:0.7; }

    /* ARCHIVIO COLLASSABILE: MESE (dentro anno) */
    .mese{
      margin: 12px 0 0;
      padding: 10px 0 0;
      border-top: 1px solid rgba(44,36,28,0.16);
    }

    .mese summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      font-size:18px;
      user-select:none;
      padding-left: 18px; /* indentazione sotto anno */
    }

    .mese summary::-webkit-details-marker{ display:none; }
    .mese summary::before{
      content:"▸";
      margin-right:8px;
      font-size:16px;
      opacity:0.6;
    }
    .mese[open] summary::before{ content:"▾"; }

    .mese-count{ font-size:13px; opacity:0.7; }

    .mese ul{
      list-style:none;
      padding:10px 0 0 36px; /* più indentazione */
      margin:0;
    }

    .mese li{ margin-bottom:6px; }

    .mese a,
    .anno a{
      text-decoration:none;
      color:var(--ink);
      border-bottom:1px solid rgba(44,36,28,0.25);
    }
    .mese a:hover,
    .anno a:hover{ border-bottom-color:rgba(44,36,28,0.6); }

    @media (max-width:720px){
      .paper{ padding:42px 26px; }
      h1{ font-size:38px; }
    }
  </style>

  <main>
    <article class="paper">
      <h1>Sentieri di Lettura</h1>

      <div class="intro">
        <p>
          I Sentieri non conducono a una meta unica.<br>
          Si aprono per essere attraversati, lasciati, ripresi.<br>
          Ognuno di essi nasce come offerta di lettura,<br>
          prende senso nell’incontro con chi legge<br>
          e non pretende di essere concluso.
        </p>
      </div>

      {sentieri.length === 0 ? (
        <p style="text-align:center; opacity:0.75;">
          I Sentieri compariranno con l’arrivo dei primi articoli.
        </p>
      ) : (
        <section class="grid">
          {sentieri.map((s) => (
            <a class="sentiero" href={`/sentieri/${slugify(s)}`}>
              {s}
            </a>
          ))}
        </section>
      )}

      <h2>Archivio per Anno</h2>

      {anni.length === 0 ? (
        <p style="text-align:center; opacity:0.75;">
          L’archivio si popolerà con l’arrivo dei primi articoli.
        </p>
      ) : (
        anni.map((anno) => {
          const mesiObj = archivioPerAnnoMese[anno];
          const mesi = Object.keys(mesiObj).map(Number).sort((a, b) => b - a); // 11..0

          return (
            <details class="anno">
              <summary>
                <span>{anno}</span>
                <span class="anno-count">{countYear(anno)} articoli</span>
              </summary>

              {mesi.map((mese) => {
                const list = mesiObj[mese]
                  .slice()
                  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

                return (
                  <details class="mese">
                    <summary>
                      <span>{monthName(mese)}</span>
                      <span class="mese-count">{list.length}</span>
                    </summary>

                    <ul>
                      {list.map((a) => (
                        <li>
                          <a href={`/articoli/${a.slug}`}>{a.data.title}</a>
                        </li>
                      ))}
                    </ul>
                  </details>
                );
              })}
            </details>
          );
        })
      )}
    </article>
  </main>
</BaseLayout>
