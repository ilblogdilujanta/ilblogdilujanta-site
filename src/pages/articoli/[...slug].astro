---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { slugify } from "../../lib/slugify";

type Articolo = CollectionEntry<"articoli">;

export async function getStaticPaths() {
  const articoli = await getCollection("articoli");
  return articoli.map((a) => ({
    params: { slug: a.slug },
  }));
}

const articoli = await getCollection("articoli");

const ordinati = articoli
  .slice()
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const slugPath = String(Astro.params.slug ?? "");
const currentIndex = ordinati.findIndex((a) => a.slug === slugPath);
const articolo = currentIndex >= 0 ? ordinati[currentIndex] : null;

if (!articolo) throw new Error(`Articolo non trovato: ${slugPath}`);

const successivo = currentIndex > 0 ? ordinati[currentIndex - 1] : null;
const precedente = currentIndex < ordinati.length - 1 ? ordinati[currentIndex + 1] : null;

const { Content } = await articolo.render();

const formatDate = (d: Date) =>
  d.toLocaleDateString("it-IT", { year: "numeric", month: "long", day: "2-digit" });

const sentieri = (articolo.data.sentieri ?? []) as string[];

// üëá subtitle opzionale (serve per mandare a capo il luogo nel titolo)
const subtitle = (articolo.data as any).subtitle as string | undefined;
---

<BaseLayout title={articolo.data.title}>
  <style is:global>
    :root{
      --ink:#2c241c;
      --green:#0d8460;
      --paper1:#efe1c5;
      --paper2:#e2caa6;
      --paper3:#d8bc93;
    }

    body{
      margin:0;
      min-height:100vh;
      background:var(--green);
      font-family:
        "Baskerville Old Face",
        "Baskerville",
        "Libre Baskerville",
        Georgia,
        "Times New Roman",
        serif;
      color:var(--ink);
    }

    main{
      display:flex;
      justify-content:center;
      padding:32px 14px;
    }

    .paper{
      max-width:980px;
      width:100%;
      padding:60px;
      background:
        radial-gradient(120% 90% at 50% 20%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--paper1), var(--paper2) 55%, var(--paper3));
      border-radius:6px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }

    h1{
      text-align:center;
      font-size:30px;
      font-weight:400;
      margin:0 0 8px;
      line-height: 1.18;
    }

    .subtitle{
      text-align:center;
      font-size:22px;
      font-weight:400;
      margin:0 0 12px;
      opacity:.92;
      line-height: 1.25;
    }

    .date{
      text-align:center;
      opacity:.75;
      margin:0 0 14px;
      font-size:18px;
    }

    .meta-row{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin:0 0 26px;
    }

    .back{
      text-decoration:none;
      color:var(--ink);
      border-bottom:1px solid rgba(44,36,28,.25);
    }
    .back:hover{ border-bottom-color: rgba(44,36,28,.6); }

    .tags{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }

    .tag{
      text-decoration:none;
      color:var(--ink);
      border:1px solid rgba(44,36,28,.22);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(255,255,255,.22);
      font-size:15px;
    }
    .tag:hover{ background: rgba(255,255,255,.38); }

    /* ===== TESTO ===== */
    .content{
      font-size:20px;
      line-height:1.75;
    }

    .content p{ margin:0 0 18px; }

    .content h2{
      font-size:30px;
      margin:38px 0 14px;
      font-weight:400;
    }

    .content h3{
      font-size:24px;
      margin:34px 0 12px;
      font-weight:400;
      opacity:.95;
    }

    /* ‚úÖ Sottolineatura ‚Äúmanuale‚Äù (es: <span class="underline">Testo</span>) */
    .content .underline{
      text-decoration: underline;
      text-underline-offset: 0.15em;   /* ‚úÖ valore valido */
      text-decoration-thickness: 1px;
    }

    /* ===== IMMAGINI (coerenti anche se Typora le mette dentro <p>) ===== */
    .content :where(img){
      display:block;
      height:auto;
      max-width:60%;
      margin:40px auto;               /* ‚úÖ spaziatura ‚Äúbase‚Äù uniforme */
      border-radius:6px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }

    /* Varianti dimensione */
    .content :where(img.img-large){ max-width:85%; }
    .content :where(img.img-small){ max-width:40%; }

    /* ===== FIGURE + DIDASCALIA ===== */
    .content figure{
      margin:40px auto;               /* stesso respiro dell‚Äôimmagine ‚Äúbase‚Äù */
      text-align:center;
    }

    /* dentro figure: togliamo i margini dell‚Äôimmagine e li gestiamo col figure */
    .content figure > img{
      margin:0 auto 0 auto;           /* ‚úÖ niente ‚Äúsalti‚Äù */
    }

    .content figure figcaption{
      margin-top:14px;                /* ‚úÖ distanza coerente */
      font-size:16px;
      line-height:1.55;
      opacity:.85;
      font-style:italic;
      text-align:center;
    }

    /* Se per qualche motivo hai vecchie didascalie come <p class="caption"> */
    .content p.caption{
      margin:-18px auto 40px;         /* vicina alla foto sopra, poi respiro sotto */
      text-align:center;
      font-size:16px;
      line-height:1.55;
      opacity:.85;
      font-style:italic;
    }

    /* ===== VIDEO ===== */
    .video{
      position:relative;
      width:70%;
      max-width:820px;
      margin:36px auto;
      aspect-ratio:16 / 9;
    }
    .video iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
    }

    /* ===== NAVIGAZIONE ===== */
    .pager{
      margin-top:42px;
      padding-top:18px;
      border-top:1px solid rgba(44,36,28,.2);
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }

    .pager a{
      flex:1;
      min-width:220px;
      text-decoration:none;
      color:var(--ink);
      border:1px solid rgba(44,36,28,.25);
      border-radius:6px;
      background:rgba(255,255,255,.22);
      padding:14px;
    }
    .pager a:hover{ background: rgba(255,255,255,.38); }

    .pager .label{
      font-size:14px;
      opacity:.75;
      margin-bottom:6px;
    }

    .pager .title{
      font-size:18px;
      line-height:1.35;
    }

    @media (max-width:720px){
      .paper{ padding:42px 26px; }
      .content{ font-size:19px; }
      .content :where(img){ max-width:92%; }
      .subtitle{ font-size:20px; }
    }
  </style>

  <main>
    <article class="paper">
      <h1>{articolo.data.title}</h1>

      {subtitle && <div class="subtitle">({subtitle})</div>}

      <p class="date">{formatDate(articolo.data.date)}</p>

      <div class="meta-row">
        <a class="back" href="/sentieri">‚Üê Torna a Sentieri</a>

        {sentieri.length > 0 && (
          <div class="tags">
            {sentieri.map((s) => (
              <a class="tag" href={`/sentieri/${slugify(s)}`}>{s}</a>
            ))}
          </div>
        )}
      </div>

      <div class="content">
        <Content />
      </div>

      <nav class="pager">
        {precedente ? (
          <a href={`/articoli/${precedente.slug}`}>
            <div class="label">‚Üê Precedente</div>
            <div class="title">{precedente.data.title}</div>
          </a>
        ) : <div></div>}

        {successivo ? (
          <a href={`/articoli/${successivo.slug}`} style="text-align:right">
            <div class="label">Successivo ‚Üí</div>
            <div class="title">{successivo.data.title}</div>
          </a>
        ) : <div></div>}
      </nav>
    </article>
  </main>
</BaseLayout>
