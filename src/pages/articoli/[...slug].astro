---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { slugify } from "../../lib/slugify";

type Articolo = CollectionEntry<"articoli">;

export async function getStaticPaths() {
  const articoli = await getCollection("articoli");

  // ✅ Catch-all in Astro: param deve essere STRINGA (es: "2016/12016-ringraziamenti")
  return articoli.map((a) => ({
    params: { slug: a.slug },
  }));
}

const articoli = await getCollection("articoli");

// Ordine: più recente -> più vecchio
const ordinati = articoli
  .slice()
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// ✅ [...slug] in Astro arriva come stringa (es: "2016/qualcosa")
const slugPath = String(Astro.params.slug ?? "");

const currentIndex = ordinati.findIndex((a) => a.slug === slugPath);
const articolo = currentIndex >= 0 ? ordinati[currentIndex] : null;

if (!articolo) throw new Error(`Articolo non trovato: ${slugPath}`);

// “Successivo” = più recente (indice - 1)
const successivo = currentIndex > 0 ? ordinati[currentIndex - 1] : null;
// “Precedente” = più vecchio (indice + 1)
const precedente = currentIndex < ordinati.length - 1 ? ordinati[currentIndex + 1] : null;

const { Content } = await articolo.render();

const formatDate = (d: Date) =>
  d.toLocaleDateString("it-IT", { year: "numeric", month: "long", day: "2-digit" });

const sentieri = (articolo.data.sentieri ?? []) as string[];
---

<BaseLayout title={articolo.data.title}>
  <style is:global>
    :root {
      --ink: #2c241c;
      --green: #0d8460;
      --paper1: #efe1c5;
      --paper2: #e2caa6;
      --paper3: #d8bc93;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--green);
      font-family:
        "Baskerville Old Face",
        "Baskerville",
        "Libre Baskerville",
        Georgia,
        "Times New Roman",
        serif;
      color: var(--ink);
    }

    main {
      display: flex;
      justify-content: center;
      padding: 32px 14px;
    }

    .paper {
      max-width: 980px;
      width: 100%;
      padding: 60px;
      background:
        radial-gradient(120% 90% at 50% 20%, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0) 55%),
        linear-gradient(180deg, var(--paper1), var(--paper2) 55%, var(--paper3));
      border-radius: 6px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
    }

    h1 {
      text-align: center;
      font-size: 30px;
      font-weight: 400;
      margin: 0 0 10px;
    }

    .date {
      text-align: center;
      opacity: 0.75;
      margin: 0 0 14px;
      font-size: 18px;
    }
.underline {
  text-decoration: underline;
  text-underline-offset: 0.15em;
}

    .meta-row {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin: 0 0 26px;
    }

    .back {
      text-decoration: none;
      color: var(--ink);
      border-bottom: 1px solid rgba(44, 36, 28, 0.25);
      opacity: 0.9;
    }
    .back:hover { border-bottom-color: rgba(44, 36, 28, 0.6); }

    .tags {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tag {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid rgba(44, 36, 28, 0.22);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.22);
      font-size: 15px;
      opacity: 0.95;
    }
    .tag:hover { background: rgba(255, 255, 255, 0.38); }

    .content {
      font-size: 20px;
      line-height: 1.75;
    }

    .content p { margin: 0 0 18px; }

    .content h2, .content h3 {
      font-weight: 400;
      margin: 38px 0 14px;
      line-height: 1.2;
    }
    .content h2 { font-size: 30px; }
    .content h3 { font-size: 24px; opacity: 0.95; }

    .content img {
      display: block;
      max-width: 60%;
      height: auto;
      margin: 70px auto;
      border-radius: 6px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .content img.img-large { max-width: 85%; }
    .content img.img-small { max-width: 40%; }

    .pager {
      margin-top: 42px;
      padding-top: 18px;
      border-top: 1px solid rgba(44, 36, 28, 0.2);
      display: flex;
      gap: 14px;
      justify-content: space-between;
      align-items: stretch;
      flex-wrap: wrap;
    }

    .pager a {
      flex: 1;
      min-width: 220px;
      text-decoration: none;
      color: var(--ink);
      border: 1px solid rgba(44, 36, 28, 0.25);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.22);
      padding: 14px 14px;
    }
    .pager a:hover { background: rgba(255, 255, 255, 0.38); }

    .pager .label {
      font-size: 14px;
      opacity: 0.75;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pager .title { font-size: 18px; line-height: 1.35; }
    .pager .empty { flex: 1; min-width: 220px; }

    @media (max-width: 720px) {
      .paper { padding: 42px 26px; }
      h1 { font-size: 40px; }
      .content { font-size: 19px; }
      .content img { max-width: 92%; margin: 50px auto; }
    }
  </style>

  <main>
    <article class="paper">
      <h1>{articolo.data.title}</h1>
      <p class="date">{formatDate(articolo.data.date)}</p>

      <div class="meta-row">
        <a class="back" href="/sentieri">← Torna a Sentieri</a>

        {sentieri.length > 0 && (
          <div class="tags" aria-label="Sentieri dell’articolo">
            {sentieri.map((s) => (
              <a class="tag" href={`/sentieri/${slugify(s)}`}>{s}</a>
            ))}
          </div>
        )}
      </div>

      <div class="content">
        <Content />
      </div>

      <nav class="pager" aria-label="Navigazione articoli">
        {precedente ? (
          <a href={`/articoli/${precedente.slug}`}>
            <div class="label">← Precedente (più vecchio)</div>
            <div class="title">{precedente.data.title}</div>
          </a>
        ) : (
          <div class="empty"></div>
        )}

        {successivo ? (
          <a href={`/articoli/${successivo.slug}`} style="text-align:right;">
            <div class="label" style="justify-content:flex-end;">
              Successivo (più recente) →
            </div>
            <div class="title">{successivo.data.title}</div>
          </a>
        ) : (
          <div class="empty"></div>
        )}
      </nav>
    </article>
  </main>
</BaseLayout>
