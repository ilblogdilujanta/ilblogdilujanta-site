---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const titoloPagina = "Luoghi di Lujanta";

// Coordinate "mitiche" Doggerland (circa Mare del Nord)
const DOGGERLAND = {
  nome: "Doggerland (terra mitica)",
  lat: 54.8,
  lng: 2.2,
};

const articoli = await getCollection("articoli");

// Helper: normalizza sentieri
const safeSentieri = (s?: unknown) => (Array.isArray(s) ? s.filter(Boolean) : []);

// Costruisco punti (luoghi) raggruppando articoli per luogo+coordinate
type Entry = (typeof articoli)[number];

type Punto = {
  key: string;
  nome: string;
  lat: number;
  lng: number;
  articoli: {
    title: string;
    slug: string;
    year: number;
    sentieri: string[];
    dateISO: string;
  }[];
};

const byKey = new Map<string, Punto>();

for (const a of articoli) {
  const year = a.data.date?.getFullYear?.() ?? new Date(a.data.date as any).getFullYear();

  // Campi attesi nel frontmatter:
  // luogo: string
  // lat: number
  // lng: number
  const luogo = (a.data as any).luogo as string | undefined;
  const lat = (a.data as any).lat as number | undefined;
  const lng = (a.data as any).lng as number | undefined;

  const hasCoords = typeof lat === "number" && typeof lng === "number" && !Number.isNaN(lat) && !Number.isNaN(lng);

  const nome = hasCoords ? (luogo?.trim() || "Luogo") : DOGGERLAND.nome;
  const useLat = hasCoords ? lat! : DOGGERLAND.lat;
  const useLng = hasCoords ? lng! : DOGGERLAND.lng;

  // key stabile (luogo + coordinate)
  const key = `${nome}__${useLat.toFixed(5)}__${useLng.toFixed(5)}`;

  if (!byKey.has(key)) {
    byKey.set(key, { key, nome, lat: useLat, lng: useLng, articoli: [] });
  }

  byKey.get(key)!.articoli.push({
    title: a.data.title,
    slug: a.slug,
    year,
    sentieri: safeSentieri((a.data as any).sentieri),
    dateISO: (a.data.date instanceof Date ? a.data.date : new Date(a.data.date as any)).toISOString(),
  });
}

// Ordino articoli dentro ogni luogo: più recenti prima
for (const p of byKey.values()) {
  p.articoli.sort((x, y) => (x.dateISO < y.dateISO ? 1 : -1));
}

// Array finale
const punti = Array.from(byKey.values());

// Anni e sentieri (per filtri)
const anni = Array.from(new Set(articoli.map((a) => (a.data.date instanceof Date ? a.data.date.getFullYear() : new Date(a.data.date as any).getFullYear()))))
  .sort((a, b) => b - a);

const sentieriUnici = Array.from(
  new Set(articoli.flatMap((a) => safeSentieri((a.data as any).sentieri)))
).sort((a, b) => a.localeCompare(b, "it"));
---

<BaseLayout title={titoloPagina}>
  <Fragment slot="head">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
  </Fragment>

  <style is:global>
    :root{
      --ink:#2c241c;
      --green:#0d8460;
      --paper1:#efe1c5;
      --paper2:#e2caa6;
      --paper3:#d8bc93;
    }

    body{
      margin:0;
      min-height:100vh;
      background: var(--green);
      font-family:
        "Baskerville Old Face","Baskerville","Libre Baskerville",
        Georgia,"Times New Roman",serif;
      color:var(--ink);
    }

    main{ display:flex; justify-content:center; padding:32px 14px; }

    .paper{
      max-width:980px;
      width:100%;
      padding:60px;
      background:
        radial-gradient(120% 90% at 50% 20%, rgba(255,255,255,0.35), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--paper1), var(--paper2) 55%, var(--paper3));
      border-radius:6px;
      box-shadow:0 18px 60px rgba(0,0,0,0.55);
    }

    h1{
      text-align:center;
      font-size:44px;
      font-weight:400;
      margin:0 0 12px;
      letter-spacing:0.2px;
    }

    .sub{
      text-align:center;
      margin:0 0 26px;
      font-size:18px;
      opacity:.88;
      line-height:1.6;
    }

    /* Barretta filtri */
    .controls{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin: 18px 0 18px;
    }
    .controls label{
      font-size:16px;
      opacity:.9;
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(44,36,28,0.22);
      border-radius: 999px;
      padding: 8px 12px;
    }
    .controls select{
      font-family: inherit;
      font-size: 16px;
      color: var(--ink);
      background: transparent;
      border: 0;
      outline: none;
      padding: 2px 6px;
    }

    /* Mappa */
    #map{
      height: 520px;
      border-radius: 8px;
      border: 1px solid rgba(44,36,28,0.22);
      box-shadow: 0 14px 40px rgba(0,0,0,0.14);
      overflow: hidden;
    }

    /* Effetto "antico" sui tiles */
    .leaflet-tile{
      filter: sepia(0.55) saturate(0.75) contrast(0.98) brightness(1.02);
    }

    /* Tooltip: deve essere cliccabile */
    .leaflet-tooltip{
      pointer-events: auto;
      background: rgba(244,241,234,0.96);
      color: var(--ink);
      border: 1px solid rgba(44,36,28,0.28);
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      border-radius: 8px;
      padding: 10px 12px;
      max-width: 320px;
    }

    .tt-title{
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 6px;
    }
    .tt-list{
      margin: 0;
      padding-left: 16px;
      line-height: 1.35;
      font-size: 15px;
    }
    .tt-list a{
      color: var(--ink);
      text-decoration: none;
      border-bottom: 1px solid rgba(44,36,28,0.25);
    }
    .tt-list a:hover{
      border-bottom-color: rgba(44,36,28,0.6);
    }
    .tt-meta{
      margin-top: 6px;
      font-size: 13px;
      opacity: .75;
    }

    @media (max-width:720px){
      .paper{ padding:42px 26px; }
      h1{ font-size:38px; }
      #map{ height: 480px; }
    }
    .leaflet-popup-content-wrapper{
  background: rgba(244,241,234,0.96);
  border: 1px solid rgba(44,36,28,0.28);
  border-radius: 8px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.18);
}

.leaflet-popup-content{
  margin: 10px 12px;
  max-width: 320px;
}

.tt-popup a{
  pointer-events: auto;
}

  </style>

  <main>
    <article class="paper">
      <h1>Luoghi di Lujanta</h1>
      <p class="sub">
        Luoghi reali e simbolici: passa sui marker per vedere gli articoli collegati.<br/>
        Se un articolo non ha coordinate, confluisce in <em>Doggerland</em>.
      </p>

      <div class="controls" aria-label="Filtri mappa">
        <label>
          Anno:
          <select id="yearFilter">
            <option value="all">Tutti</option>
            {anni.map((y) => <option value={String(y)}>{y}</option>)}
          </select>
        </label>

        <label>
          Sentiero:
          <select id="trailFilter">
            <option value="all">Tutti</option>
            {sentieriUnici.map((s) => <option value={s}>{s}</option>)}
          </select>
        </label>
      </div>

      <div id="map" aria-label="Mappa dei luoghi"></div>
    </article>
  </main>

    <script
    is:inline
    define:vars={{ PUNTI: punti, DOGGERLAND }}
  >
    // ✅ DATI INIETTATI CORRETTAMENTE (niente JSON.parse / doppie stringify)
    // Qui PUNTI e DOGGERLAND sono già variabili JS disponibili.

    // Carico Leaflet + MarkerCluster da CDN
    const loadScript = (src) =>
      new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.defer = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });

    (async () => {
      await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");
      await loadScript(
        "https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
      );

      const L = window.L;

      const map = L.map("map", {
        zoomControl: true,
        scrollWheelZoom: true,
      });

      // OSM (poi "antichizzato" via CSS filter)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap",
        maxZoom: 18,
      }).addTo(map);

      const cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        maxClusterRadius: 42,
      });

      const yearSel = document.getElementById("yearFilter");
      const trailSel = document.getElementById("trailFilter");

      if (!yearSel || !trailSel) return;

      function matchesFilters(article) {
        const y = yearSel.value;
        const t = trailSel.value;

        const yearOk = y === "all" || String(article.year) === y;
        const trailOk =
          t === "all" || (article.sentieri && article.sentieri.includes(t));
        return yearOk && trailOk;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function tooltipHTML(p) {
        // articoli filtrati
        const list = p.articoli.filter(matchesFilters);
        if (list.length === 0) return null;

        const items = list
          .map(
            (a) =>
              `<li><a href="/articoli/${a.slug}">${escapeHtml(
                a.title
              )}</a></li>`
          )
          .join("");

        const meta = [];
        if (p.nome === DOGGERLAND.nome) meta.push("Articoli senza coordinate");
        meta.push(`${list.length} articol${list.length === 1 ? "o" : "i"}`);

        return `
          <div class="tt">
            <div class="tt-title">${escapeHtml(p.nome)}</div>
            <ul class="tt-list">${items}</ul>
            <div class="tt-meta">${meta.join(" • ")}</div>
          </div>
        `;
      }

      function fitToVisible() {
        const layers = cluster.getLayers();
        if (!layers || layers.length === 0) {
          // fallback Europa
          map.setView([51.0, 10.0], 4);
          return;
        }
        const group = L.featureGroup(layers);
        map.fitBounds(group.getBounds().pad(0.18), { animate: false });
      }

      function buildMarkers() {
        cluster.clearLayers();

        for (const p of PUNTI) {
          const html = tooltipHTML(p);
          if (!html) continue;

          const marker = L.circleMarker([p.lat, p.lng], {
            radius: 6,
            weight: 1.5,
            color: "rgba(44,36,28,0.75)",
            fillColor: "rgba(44,36,28,0.65)",
            fillOpacity: 0.8,
          });

          // Tooltip per hover (va bene anche non interattivo, tanto il click userà il popup)
marker.bindTooltip(html, {
  direction: "top",
  offset: [0, -6],
  opacity: 1,
  sticky: true,
  interactive: false,
});

// Popup “bloccato” al click (qui i link sono cliccabili)
marker.bindPopup(html, {
  closeButton: true,
  autoClose: true,     // chiude gli altri popup quando ne apri uno
  closeOnClick: true,  // click sulla mappa chiude
  className: "tt-popup",
  offset: [0, -8],
});

// Al click apri il popup (pinnato)
marker.on("click", () => {
  marker.openPopup();
});


          cluster.addLayer(marker);
        }

        map.addLayer(cluster);
        fitToVisible();
      }

      yearSel.addEventListener("change", buildMarkers);
      trailSel.addEventListener("change", buildMarkers);

      // Primo render
      buildMarkers();
    })();
  </script>

</BaseLayout>
